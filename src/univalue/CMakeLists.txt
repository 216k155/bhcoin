# Copyright (c) 2018 The Luxcore developers
cmake_minimum_required(VERSION 3.5)
project(univalue)

option(UNIVALUE_BUILD_TESTS "Build univalue's unit tests" OFF)

include_directories(include)

add_library(univalue
	lib/univalue.cpp
	lib/univalue_get.cpp
	lib/univalue_read.cpp
	lib/univalue_write.cpp
)

target_include_directories(univalue
	PUBLIC
		include
	PRIVATE
		lib
)

if(UNIVALUE_BUILD_TESTS)
	enable_testing()

	add_executable(unitester_test test/unitester.cpp)
	add_test(NAME unitester_test COMMAND unitester_tests)
	target_link_libraries(unitester_test univalue)

	target_compile_definitions(unitester_test
		PUBLIC JSON_TEST_SRC="${PROJECT_SOURCE_DIR}/test"
	)

	add_executable(json_test test/test_json.cpp)
	add_test(NAME json_test COMMAND json_test)
	target_link_libraries(json_test univalue)

	add_executable(no_nul_test test/no_nul.cpp)
	add_test(NAME no_nul_test COMMAND no_nul_test)
	target_link_libraries(no_nul_test univalue)

	add_executable(object_test test/object.cpp)
	add_test(NAME object_test COMMAND object_test)
	target_link_libraries(object_test univalue)
endif(UNIVALUE_BUILD_TESTS)

# Generate lib/univalue_escapes.h
include(NativeExecutable)
add_native_executable(univalue_gen gen/gen.cpp)
native_target_include_directories(univalue_gen PUBLIC include)

# Custom target to regenerate univalue_escapes.h
add_custom_target(generate_univalue_escapes_h
		COMMAND univalue_gen > ${CMAKE_CURRENT_SOURCE_DIR}/lib/univalue_escapes.h
		)